name: ci
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-18.04
    services:
      mongodb:
        image: mongo:4
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python 2.7
        uses: actions/setup-python@v2
        with:
          python-version: 2.7
      - name: Install dependencies
        run: |
          sudo mkdir /etc/redis
          printf "bind 127.0.0.1\ndaemonize yes\n" | sudo tee /etc/redis/redis.conf
          sudo apt-get update && sudo -E apt-get install -y unzip redis-server || journalctl -u redis-server -n 30 && exit 1
          pip install -U pip
          make deps
          curl -k -LO https://releases.hashicorp.com/consul/0.6.4/consul_0.6.4_linux_amd64.zip
          unzip consul_0.6.4_linux_amd64.zip
          export GOMAXPROCS=8 PATH=$PATH:$PWD
          make start-consul
      - name: Run test
        run: make ci-test
